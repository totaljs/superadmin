<div class="filter nmb">
	<div class="container">
		<div class="row">
			<div class="col-md-4 m">
				<div class="textboxsearch" data-jc="textbox" data-jc-path="applications.filter.search" data-jc-config="type:search;autofocus:true;placeholder:@(Search applications)"></div>
			</div>
			<div class="col-md-4 center hidden-sm hidden-xs">
				@(Your IP address:)
				<div data-jc="" data-jc-path="su.ip" class="black b" style="font-size:24px"></div>
			</div>
			<div class="col-md-4 m">
				<div class="operations">
					<button class="operation-button" name="add" title="@(Add application)"><i class="fa fa-plus-circle"></i></button>
					<button class="operation-button" name="addsubprocess" title="@(Add subprocess)"><i class="fa fa-plug"></i></button>
					<button class="operation-button" name="analyzator" title="@(Logs analyzator)"><i class="fa fa-bug"></i></button>
					<button class="operation-button" name="summary" title="@(Summary)"><i class="fa fa-bar-chart"></i></button>
					<button class="operation-button" name="restart" title="@(Restart all)"><i class="fa fa-refresh"></i></button>
					<button class="operation-button" name="options" title="@(Options)"><i class="fa fa-server"></i></button>
				</div>
			</div>
		</div>
	</div>
</div>

<br />

<div class="container">
	<div class="visible-xs visible-sm statsmenu">
		<button class="exec" data-exec="statsmenu"><i class="fa fa-cog mr5"></i>@(System information)</button><i class="fa fa-caret-down"></i>
	</div>
	<div data-jc="tagger" data-jc-path="applications.stats" class="panelstats">
		<div class="caption"><i class="fa fa-server"></i>@(Memory)</div>
		<div class="stats">
			<div><i class="fa fa-square mr5"></i>@(Total)</div>
			<div data-name="memtotal" data-format="n => n.filesize(1)">...</div>
		</div>
		<div class="stats">
			<div><i class="fa fa-square mr5 green"></i>@(Free)</div>
			<div data-name="memfree" data-format="n => n.filesize(1)">...</div>
		</div>
		<div class="stats">
			<div><i class="fa fa-square mr5 red"></i>@(Used)</div>
			<div data-name="memused" data-format="n => n.filesize(1)" class="b">...</div>
		</div>
		<div data-jc="freeprogress" data-jc-path="applications.stats" data-type="memory"></div>
		<div class="stats">
			<div>@(Applications (RSS))</div>
			<div data-name="memory" data-format="n => n.filesize(1)">...</div>
		</div>
		<div class="stats">
			<div>@(Count)</div>
			<div data-name="count">...</div>
		</div>

		<div class="cpu">
			<div data-name="cpu">...</div>
			<div class="fs11">@(CPU utilization (all cores))</div>
			<div data-jc="freeprogress" data-jc-path="applications.stats" data-type="cpu"></div>
		</div>

		<div class="row">
			<div class="col-sm-6 col-md-12">
				<div class="caption"><i class="fa fa-hdd-o"></i>@(HDD)</div>
				<div class="stats mt10">
					<div>@(Total)</div>
					<div data-name="hddtotal" data-format="n => n.filesize(1)">...</div>
				</div>
				<div class="stats">
					<div>@(Free)</div>
					<div data-name="hddfree" data-format="n => n.filesize(1)">...</div>
				</div>
				<div class="stats">
					<div>@(Used)</div>
					<div data-name="hddused" data-format="n => n.filesize(1)" class="b">...</div>
				</div>
				<div data-jc="freeprogress" data-jc-path="applications.stats" data-type="hdd"></div>
			</div>
			<div class="col-sm-6 col-md-12">
				<div class="caption"><i class="fa fa-sitemap"></i>@(Network)</div>
				<div class="stats mt10">
					<div>@(Open connections)</div>
					<div><i class="fa fa-circle green blink fs10 mr5"></i><span data-name="networkconnections" data-after="x">...</span></div>
				</div>
				<div class="stats">
					<div>@(Upload)</div>
					<div data-name="networkupload" data-format="n => n.filesize(1)">...</div>
				</div>
				<div class="stats">
					<div>@(Download)</div>
					<div data-name="networkdownload" data-format="n => n.filesize(1)">...</div>
				</div>
			</div>
		</div>

		<div class="row">
			<div class="col-md-12 col-xs-6" data-name="nginx" data-visible="n => n" class="hidden">
				<br />
				<div class="caption"><i class="fa fa-server"></i>@(Nginx)</div>
				<div class="stats mt10">
					<div>@(CPU)</div>
					<div data-name="nginx.cpu">...</div>
				</div>
				<div class="stats">
					<div>@(Memory)</div>
					<div data-name="nginx.memory" data-format="n => n.filesize(1)">...</div>
				</div>
				<div class="stats">
					<div>@(Version)</div>
					<div data-name="version_nginx" data-before="v">...</div>
				</div>
			</div>

			<div class="col-md-12 col-xs-6" data-name="mongodb" data-visible="n => n" class="hidden">
				<br />
				<div class="caption"><i class="fa fa-database"></i>@(MongoDB)</div>
				<div class="stats mt10">
					<div>@(CPU)</div>
					<div data-name="mongodb.cpu">...</div>
				</div>
				<div class="stats">
					<div>@(Memory)</div>
					<div data-name="mongodb.memory" data-format="n => n.filesize(1)">...</div>
				</div>
				<div class="stats">
					<div>@(Version)</div>
					<div data-name="version_mongodb" data-before="v">...</div>
				</div>
			</div>

			<div class="col-md-12 col-xs-6" data-name="postgresql" data-visible="n => n" class="hidden">
				<br />
				<div class="caption"><i class="fa fa-database"></i>@(PostgreSQL)</div>
				<div class="stats mt10">
					<div>@(CPU)</div>
					<div data-name="postgresql.cpu">...</div>
				</div>
				<div class="stats">
					<div>@(Memory)</div>
					<div data-name="postgresql.memory" data-format="n => n.filesize(1)">...</div>
				</div>
				<div class="stats">
					<div>@(Version)</div>
					<div data-name="version_postgresql" data-before="v">...</div>
				</div>
			</div>

			<div class="col-md-12 col-xs-6" data-name="mysql" data-visible="n => n" class="hidden">
				<br />
				<div class="caption"><i class="fa fa-database"></i>@(MySQL)</div>
				<div class="stats mt10">
					<div>@(CPU)</div>
					<div data-name="mysql.cpu">...</div>
				</div>
				<div class="stats">
					<div>@(Memory)</div>
					<div data-name="mysql.memory" data-format="n => n.filesize(1)">...</div>
				</div>
				<div class="stats">
					<div>@(Version)</div>
					<div data-name="version_mysql" data-before="v">...</div>
				</div>
			</div>

			<div class="col-md-12 col-xs-6" data-name="couchdb" data-visible="n => n" class="hidden">
				<br />
				<div class="caption"><i class="fa fa-database"></i>@(CouchDB)</div>
				<div class="stats mt10">
					<div>@(CPU)</div>
					<div data-name="couchdb.cpu">...</div>
				</div>
				<div class="stats">
					<div>@(Memory)</div>
					<div data-name="couchdb.memory" data-format="n => n.filesize(1)">...</div>
				</div>
				<div class="stats">
					<div>@(Version)</div>
					<div data-name="version_couchdb" data-before="v">...</div>
				</div>
			</div>

			<div class="col-md-12 col-xs-6" data-name="redis" data-visible="n => n" class="hidden">
				<br />
				<div class="caption"><i class="fa fa-database"></i>@(Redis)</div>
				<div class="stats mt10">
					<div>@(CPU)</div>
					<div data-name="redis.cpu">...</div>
				</div>
				<div class="stats">
					<div>@(Memory)</div>
					<div data-name="redis.memory" data-format="n => n.filesize(1)">...</div>
				</div>
				<div class="stats">
					<div>@(Version)</div>
					<div data-name="version_redis" data-before="v">...</div>
				</div>
			</div>
		</div>

		<br />
		<div class="caption" data-name="version_server">...</div>
		<div class="stats mt5">
			<div>@(Uptime)</div>
			<div data-name="uptime" data-format="n => Tangular.helpers.uptime(n)">...</div>
		</div>
		<div class="stats">
			<div>@(Node.js)</div>
			<div data-name="version_node" data-before="v">...</div>
		</div>
		<div class="stats hidden" data-visible="n => n" data-name="version_gm">
			<div>@(GraphicsMagick)</div>
			<div data-name="version_gm" data-before="v">...</div>
		</div>
	</div>

	<div data-jc="applications" data-jc-path="applications.grid" class="panelapps">
		<script type="text/html">
			<tr data-search="{{ url }}" class="tr{{ if subprocess }} tr-subprocess{{ fi }}{{ if $.last }} tr-subprocess-last{{ fi }}{{ if stopped }} stopped{{ fi }}" data-id="{{ id }}" data-category="{{ category }}"{{ if notes }} title="@(Notes:) {{ notes | strip }}"{{ fi }}>
				<td>
					<div class="app-name">
						<a href="{{ url }}{{ path }}" target="_blank" class="name"><i class="fa fa-bug"></i>{{ url | application-name }}{{ path }}{{ if backup }}<i class="fa fa-copy ml5 fs10 silver" title="@(Backup is activated)"></i>{{ fi }}{{ if cluster > 1 }}<span class="badge badge-silver cluster">{{ cluster }}</span>{{ fi }}</a>
					</div>
					<div class="app-mode">
						{{ if debug }}<i class="fa fa-flask mr5"></i><span class="badge badge-purple">@(debug)</span>{{ else }}&nbsp;{{ fi }}
					</div>
					<div class="app-info">
						<div data-jc="application-appinfo" data-port="{{ port }}" data-jc-path="applications.info"></div>
					</div>
					<div class="app-port">
						<span class="badge badge-silver">{{ port }}</span>
					</div>
					<div class="app-buttons">
						<a href="/logs/{{ id }}/" target="_blank" title="@(Show logs)"><i class="fa fa-search"></i></a>
						<button class="application-button" name="restart" title="@(Restart)"><i class="fa fa-refresh"></i></button>
						<button class="application-button" name="menu" title="@(Settings)"><i class="fa fa-navicon"></i></button>
					</div>
				</td>
			</tr>
		</script>
	</div>

</div>
<div class="clearfix"></div>
<div id="end"></div>
<br />

<div data-jc="importer" data-jc-path="common.form" data-jc-config="if:value === 'applications-analyzator';reload:applications_analyzator_refresh;url:/templates/applications-form-analyzator.html"></div>
<div data-jc="importer" data-jc-path="common.layer" data-jc-config="if:value.indexOf('applications-summary') !== -1;reload:applications_summary_refresh;url:/templates/applications-form-summary.html"></div>
<div data-jc="importer" data-jc-path="common.form" data-jc-config="if:value === 'applications-logs';reload:applications_logs_refresh;url:/templates/applications-form-logs.html"></div>
<div data-jc="importer" data-jc-path="common.form" data-jc-config="if:value === 'applications-backup';url:/templates/applications-form-backup.html"></div>
<div data-jc="importer" data-jc-path="common.form" data-jc-config="if:value === 'applications-upload';reload:applications_upload_refresh;url:/templates/applications-form-upload.html"></div>
<div data-jc="importer" data-jc-path="common.form" data-jc-config="if:value === 'applications-subprocess';reload:applications_subprocess_refresh;url:/templates/applications-form-subprocess.html"></div>
<div data-jc="importer" data-jc-path="common.form" data-jc-config="if:value === 'applications-stdout';url:/templates/applications-stdout.html"></div>
<div data-jc="importer" data-jc-path="common.form" data-jc-config="if:value === 'applications';reload:applications_form_refresh;url:/templates/applications-form.html"></div>
<div data-jc="importer" data-jc-path="common.layer" data-jc-config="if:value.indexOf('filebrowser') !== -1;url:/templates/filebrowser.html"></div>

<script>

	var applications = {};

	applications.filter = {};
	applications.filter.page = 1;
	applications.grid = {};
	applications.form = {};
	applications.info = null;
	applications.stats = {};
	applications.waiting = false;
	applications.id = null;          // contains current application (when the user click on some button in the grid)
	applications.sslexpire = {};
	applications.merrors = {};

	$(document).on('click', '.application-button', function(e) {
		var button = $(this);
		var id = button.closest('tr').attr('data-id');
		var app = applications.grid.findItem('id', id);

		applications.id = id;

		switch (this.name) {
			case 'restart':
				applications_restart(id);
				return;

			case 'menu':

				var items = [];

				!isMOBILE && su.filebrowser && items.push({ name: '<b>@(File Browser)</b>', icon: 'fa-folder', value: 'filebrowser' });
				items.push({ name: '<b>@(Settings)</b>', icon: 'fa-cog', value: 'settings' });
				items.push({ name: '@(Restart)', icon: 'fa-refresh', value: 'restart' });
				items.push({ name: '@(Stop)', icon: 'fa-stop-circle', value: 'stop' });
				items.push({ name: '@(Upload ZIP)', icon: 'fa-cloud-upload', value: 'upload' });
				items.push({ name: '@(Download ZIP)', icon: 'fa-cloud-download', value: 'download' });
				items.push({ name: '@(Remove)', icon: 'fa-times-circle', value: 'remove' });

				var reverse = ($('#end').offset().top - button.offset().top) < 240;

				FIND('contextmenu').show('right' + (reverse ? ' reverse' : ''), this, items, function(value) {

					switch (value) {
						case 'remove':
							FIND('confirm').confirm('@(Are you sure you want to remove this application?)', ['@(Yes)', '@(Cancel)'], function(index) {
								if (index)
									return;
								SETTER('loading', 'show');

								if (app) {
									delete applications.sslexpire[app.port];
									delete applications.merrors[app.id];
								}

								AJAX('DELETE /api/apps/{0}/remove/'.format(id), function(response) {
									setTimeout(applications_refresh, 100);
									success();
								});
							});
							return;
						case 'restart':
							applications_restart(id);
							return;
						case 'filebrowser':
							SETTER('loading', 'show');
							SET('filebrowser.id', id);
							PUSH('common.layer', 'filebrowser');
							SETTER('loading', 'hide', 1000);
							break;
						case 'stop':
							SETTER('loading', 'show');
							AJAX('GET /api/apps/{0}/stop/'.format(id), function(response) {
								applications_info();
								button.closest('tr').rclass('error');
								success();
							});
							return;
						case 'upload':
							SET('common.form', 'applications-upload');
							return;
						case 'download':
							location.href = '/api/apps/{0}/pack/'.format(id);
							return;
						case 'logs':
							SET('common.form', 'applications-logs');
							return;
						case 'settings':
							applications_edit(id, -1);
							return;
						}
				}, 12, 0);
				return;
		}
	});

	function applications_restart(id, callback) {
		delete applications.merrors[id];
		SETTER('loading', 'show');
		AJAX('GET /api/apps/{0}/restart/'.format(id), function(response) {
			$('tr[data-id="{0}"]'.format(id)).rclass('error');
			success();
			callback && callback();
		});
	}

	$(document).on('click', '.operation-button', function() {
		switch (this.name) {

			case 'summary':
				PUSH('common.layer', 'applications-summary', 100);
				break;

			case 'analyzator':
				SET('common.form', 'applications-analyzator', 100);
				break;

			case 'add':
				applications_new();
				break;

			case 'addsubprocess':
				applications_newsubprocess();
				break;

			case 'options':
				FIND('contextmenu').show('right', this, [{ name: '@(Re-configure all)', icon: 'fa-retweet', value: 'reconfigure' }, { name: 'Backup server', icon: 'fa-cloud-download', value: 'backup' }, { name: '@(Nginx test)', icon: 'fa-flask', value: 'nginx' }, { name: '@(SuperAdmin logs)', icon: 'fa-file-text-o', value: 'logs' }, { name: '@(Server logins)', icon: 'fa-lock', value: 'last' }, { name: '@(Stop all)', icon: 'fa-stop-circle', value: 'stop' }, { name: 'Fix permissions', icon: 'fa-wrench', value: 'permissions' }], function(value) {

					if (value === 'permissions') {
						FIND('confirm').confirm('@(Are you sure you want to fix permissions for the root?)', ['@(Yes)', '@(Cancel)'], function(index) {
							if (index)
								return;
							SETTER('loading', 'show');
							AJAX('GET /api/permissions/', function() {
								SETTER('loading', 'hide', 1000);
							});
						});
						return;
					}

					if (value === 'backup') {
						FIND('confirm').confirm('@(Are you sure you want to create a backup of the whole server?)', ['@(Yes)', '@(Cancel)'], function(index) {
							if (index)
								return;
							SETTER('loading', 'show');
							SETTER('loading', 'hide', 1000);
							SET('common.form', 'applications-backup');
							location.href = '/api/apps/backup/';
						});
						return;
					}

					if (value === 'reconfigure') {
						FIND('confirm').confirm('@(Are you sure you want to reconfigure all applications?)', ['@(Yes)', '@(Cancel)'], function(index) {
							if (index)
								return;
							SETTER('loading', 'show');
							applications.waiting = true;
							applications.sslexpire = {};
							AJAX('GET /api/apps/reconfigure/', function(response) {
								applications.waiting = false;
								applications_info();
								success();
							});
						});
						return;
					}

					if (value === 'stop') {
						FIND('confirm').confirm('@(Are you sure you want to stop all applications?)', ['@(Yes)', '@(Cancel)'], function(index) {
							if (index)
								return;
							SETTER('loading', 'show');
							applications.waiting = true;
							AJAX('GET /api/apps/stop/', function(response) {
								applications.waiting = false;
								applications_info();
								success();
							});
						});
						return;
					}

					if (value === 'stop') {
						FIND('confirm').confirm('@(Are you sure you want to stop all applications?)', ['@(Yes)', '@(Cancel)'], function(index) {
							if (index)
								return;
							SETTER('loading', 'show');
							applications.waiting = true;
							AJAX('GET /api/apps/stop/', function(response) {
								applications.waiting = false;
								applications_info();
								success();
							});
						});
						return;
					}

					AJAX('GET /api/{0}/'.format(value), 'applications.stdout.lines');
					SET('common.form', 'applications-stdout');
				}, -5);
				break;

			case 'restart':
				FIND('confirm').confirm('@(Are you sure you want to restart all applications?)', ['@(Yes)', '@(Cancel)'], function(index) {
					if (index)
						return;
					SETTER('loading', 'show');
					applications.waiting = true;
					applications.sslexpire = {};
					applications.merrors = {};
					AJAX('GET /api/apps/restart/', function(response) {
						applications.waiting = false;
						success();
					});
				});
				break;
		}
	});

	// Watch for changes in product filter
	WATCH('applications.filter.search', function(path, value) {
		if (NOTMODIFIED('applications.filter', applications.filter))
			return;

		if (!value)
			value = '';

		value = value.toLowerCase();
		var categories = {};

		FIND('applications', function(component) {
			component.element.find('tr.tr').each(function(index) {
				var el = $(this);
				var search = el.attr('data-search').toLowerCase();
				var no = value ? search.indexOf(value) === -1 : false;
				el.tclass('hidden', no);
				if (!no)
					categories[el.attr('data-category')] = true;
			});
			component.element.find('.category,.items').each(function() {
				$(this).tclass('hidden', categories[this.getAttribute('data-category')] === undefined);
			});
		})
	});

	function applications_edit(id, index) {
		var loading = FIND('loading');
		loading.show();
		applications.id = id;
		AJAX('GET /api/apps/{0}/'.format(id), function(response) {

			loading.hide(500);

			// Error prevention
			if (response instanceof Array) {
				FIND('message').warning(response[0].error);
				return;
			}

			if (response.memory === 0)
				response.memory = undefined;

			if (response.subprocess) {
				SET('applications.subprocess', $.extend({ $index: index }, response), true);
				SET('common.form', 'applications-subprocess');
			} else {
				response.sslexpire = applications.sslexpire[response.port];
				SET('applications.form', $.extend({ $index: index }, response), true);
				SET('common.form', 'applications');
			}
		});
	}

	function applications_new() {
		applications.id = null;
		SET('common.form', 'applications');
	}

	function applications_newsubprocess() {
		applications.id = null;
		SET('common.form', 'applications-subprocess');
	}

	// Method refreshes grid
	function applications_refresh(reset) {

		if (reset)
			applications.filter.page = 1;

		clearTimeout2('applications.refresh');

		AJAX('GET /api/apps/', applications.filter, function(response, err) {

			if (err) {
				setTimeout2('applications.refresh', applications_refresh, 1000);
				return;
			}

			var categories = {};

			applications.filter.search = '';
			NOTIFY('applications.filter.search');
			SET('applications.grid', response);

			response.forEach(function(item) {
				if (item.category)
					categories[item.category] = true;
			});

			SET('applications.categories', Object.keys(categories));
			applications_info();
		});

		applications_stats();
	}

	function applications_reload() {
		var hash = location.hash;
		hash && hash.length > 1 && setTimeout(function() {
			applications_edit(hash.substring(1));
		}, 500);
	}

	function applications_init() {
		FIND('applications', function() {
			applications_refresh(true);
			setTimeout(applications_notifications, 2000);
		});
	}

	function applications_notifications() {
		AJAX('GET /api/notifications/', function(response) {
			response.length && response.forEach(function(item) {
				SETTER('notifications', 'append', item.icon || 'fa-info-circle', item.body, item.datecreated, NOOP, item.color || '#3BAFDA');
			});
		});
	}

	function applications_info() {

		var timeout = 6000;
		clearTimeout(applications.timeout_info);

		if (applications.waiting) {
			applications.timeout_info = setTimeout(applications_info, timeout);
			return;
		}

		AJAX('GET /api/apps/info/', function(response, err) {

			if (err)
				return;

			SET('applications.info', response);
			applications.timeout_info = setTimeout(applications_info, timeout);

			var sum = 0;
			var now = Date.now();
			var has = false;

			response.forEach(function(item) {
				sum += item.memory;

				if (item.sslexpire)
					item.sslexpire = item.sslexpire.parseDate();

				if (!item.sslexpire || applications.sslexpire[item.port])
					return;

				var diff = (item.sslexpire.getTime() - now) / 1000;
				var app = applications.grid.findItem('port', item.port);

				applications.sslexpire[item.port] = { type: 1, id: app.id, expire: item.sslexpire };
				if (diff < 0) {
					has = true;
					applications.sslexpire[item.port].type = 2;
					SETTER('notifications', 'append', 'fa-warning', '@(<b class="red">The certificate is expired</b> for domain <a href="{0}" target="_blank">{0}</a>, you have to renew it.)'.format(app.url), item.sslexpire, function() {
						applications_edit(app.id, -1);
					}, '#D53F39');
				} else if (diff <= 259200) {
					has = true;
					applications.sslexpire[item.port].type = 3;
					SETTER('notifications', 'append', 'fa-clock-o', '@(<b>The certificate will expire</b> for domain <a href="{0}" target="_blank">{0}</a> in short time, you have to renew it.)'.format(app.url), item.sslexpire, function() {
						applications_edit(app.id, -1);
					}, '#E9573F');
				}
			});

			has && SETTER('audio', 'play', '/error.mp3');
			var elements = FIND('applications').element.find('.tr');

			Object.keys(applications.sslexpire).forEach(function(key) {
				var obj = applications.sslexpire[key];
				if (obj.type === 1)
					return;
				var tr = elements.filter('[data-id="{0}"]'.format(obj.id));
				tr.find('.ssl').tclass('ssl-expired', obj.type === 2).tclass('ssl-expire', obj.type === 3);
			});

			SET('applications.stats.memory', sum);
			SET('applications.stats.count', response.length);
		});
	}

	function applications_stats() {
		clearTimeout(applications.timeout_stats);

		if (common.page !== 'applications') {
			applications.timeout_stats = setTimeout(applications_stats, 10000);
			return;
		}

		AJAX('GET /api/stats/', function(response) {
			EXTEND('applications.stats', response);
			applications.timeout_stats = setTimeout(applications_stats, 10000);
		});
	}

	COMPONENT('applications', function(self) {

		var recompile = false;
		var template_table = '<div class="items" data-category="{1}"><table border="0">{0}</table></div>';
		var template_category = '<div class="category" data-category="{0}"><span>{1}</span><i class="fa fa-folder"></i>{0}</div>';
		var REG_CLEANURL = /^(http|https)\:\/\//g;

		self.readonly();

		self.make = function() {

			var element = self.find('script');

			if (!element.length) {
				element = self.element;
				self.element = self.element.parent();
			}

			var html = element.html();
			element.remove();
			self.template = Tangular.compile(html);
			recompile = html.indexOf('data-jc="') !== -1;
			self.aclass('applications');
		};

		self.setter = function(value) {

			if (!value || !value.length) {
				self.empty();
				return;
			}

			var categories = {};
			var subprocesses = {};

			self.toggle('hidden', true);
			self.empty();

			value.forEach(function(item) {

				if (item.subprocess) {
					!subprocesses[item.url] && (subprocesses[item.url] = []);
					subprocesses[item.url].push(item);
					return;
				}

				if (categories[item.category])
					categories[item.category].push(item);
				else
					categories[item.category] = [item];
			});

			var keys = Object.keys(categories);

			keys.sort(function(a, b) {
				return a.substring(0, 15).toLowerCase().localeCompare(b.substring(0, 15).toLowerCase());
			});

			keys.forEach(function(name) {

				var builder = [];
				var items = categories[name];
				var memory = 0;

				items.sort(function(a, b) {
					var an = a.url.replace(REG_CLEANURL, '').substring(0, 15).toLowerCase();
					var bn = b.url.replace(REG_CLEANURL, '').substring(0, 15).toLowerCase();
					return an.localeCompare(bn);
				});

				items.forEach(function(item, index) {
					builder.push(self.template(item));
					var sub = subprocesses[item.url];
					if (!sub)
						return;
					var length = sub.length - 1;
					sub.forEach(function(item, index) {
						memory += item.memory;
						builder.push(self.template(item, { last: index === length }));
					});
				});

				self.append((name ? template_category.format(name, builder.length) : '') + template_table.format(builder.join(''), name));
			});

			recompile && COMPILE();
			setTimeout(function() {
				self.toggle('hidden', false);
			}, 100);
		};
	});

	COMPONENT('application-appinfo', function() {

		var self = this;
		var port = +self.attrd('port');
		var empty = '<div class="offline">@(OFFLINE)</div>';
		var parent;

		self.template = Tangular.compile('<table><tr><td title="@(Uptime)" class="ttd-uptime">{{ time | application-uptime }}</td><td class="ttd-hdd" title="@(Directory size)">{{ hdd | filesize(0) }}<i class="fa fa-folder-o ml5"></i></td><td class="ttd-cpu" title="@(CPU utilization)">{{ cpu | application-round }}{{ cpu | application-progress(\'cpu\', 100) }}</td><td class="ttd-memory" title="@(Memory utilization)">{{ memory | filesize(1) }}</td><td class="ttd-files" title="@(All open files)">{{ openfiles }}<i class="fa fa-hdd-o ml5"></i></td><td class="ttd-connections{{ if connections > 0 }} green{{ fi }}" title="@(All open connections on 80)">{{ connections }}<i class="fa fa-globe ml5"></i></td></tr></table>');

		self.make = function() {
			parent = self.element.closest('tr');
		};

		self.readonly();

		self.setter = function(value) {

			if (!value)
				return self.empty();

			var obj = value.findItem('port', port);
			if (obj)
				self.html(self.template(obj));
			else
				self.html(empty);

			parent.tclass('stopped', obj ? false : true);
		};
	});

	Tangular.register('application-name', function(value) {
		var https = value.substring(0, 8) === 'https://';
		return (!this.subprocess && https ? '<span class="ssl">ssl</span>' : '') + value.replace(/(http|https)\:\/\//g, '');
	});

	Tangular.register('application-uptime', function(value) {
		if (value == null)
			return '';
		var arr = value.split('-');
		return arr.length === 1 ? arr[0] : '<span class="time">{0}</span>'.format(arr[0].parseInt().pluralize('#Â days', '# day', '# days', '# days'));
	});

	Tangular.register('application-round', function(value) {
		if (value == null)
			return '';
		var m = value.match(/[0-9\.]+/g);
		return m ? Math.round(m.toString().parseFloat()) + value.replace(m, '') : value;
	});

	Tangular.register('application-progress', function(value, type, max) {

		if (value == null)
			return '';

		if (this.cluster > 1)
			max *= this.cluster;

		var current = Math.round(typeof(value) === 'number' ? value : value.replace(/(\s|\%|MB)?/g, '').parseFloat());
		var percentage = (current / max) * 100;
		if (percentage > 100)
			percentage = 100;

		return '<div class="progress"><div style="background-color:{1};width:{0}%"></div></div>'.format(percentage, percentage < 20 ? 'green' : percentage < 60 ? 'orange' : 'red');
	});

	Tangular.register('format2', function(value) {
		if (value == null)
			return '...';
		if (value >= 1000000)
			return (value / 1000000).format(1) + ' M';
		if (value >= 1000)
			return (value / 1000).format(1) + ' K';
		return value.format(0);
	});

	COMPONENT('freeprogress', function() {
		var self = this;
		var progress;
		var width = {};
		var css = {};

		self.readonly();
		self.make = function() {
			self.css({ height: '3px', margin: '8px 0 {0}'.format(self.attr('data-type') === 'memory' ? '8px' : '15px'), 'background-color': '#F0F0F0' });
			self.append('<div style="height:3px;width:0"></div>');
			progress = self.find('div');
		};

		self.setter = function(value) {

			if (!value)
				return;

			var val = 0;

			switch (self.attr('data-type')) {
				case 'memory':
					val = (value.memused / value.memtotal) * 100;
					break;
				case 'hdd':
					val = (value.hddused / value.hddtotal) * 100;
					break;
				case 'cpu':
					val = value.cpu ? value.cpu.parseFloat() : 0;
					break;
			}

			width.width = val >= 0 ? Math.round(val) + '%' : '0';

			css['background-color'] = val < 20 ? '#8CC152' : val < 50 ? '#F6BB42' : val < 70 ? '#E9573F' : '#DA4453';
			progress.animate(width, 300);
			progress.css(css);
		};
	});

	function applications_app_reqstats(reqstats) {

		var values = {};
		if (!reqstats)
			return values;

		var dt = new Date();
		var current_m = dt.format('yyyy-MM');
		var previous_m = dt.add('-1 month').format('yyyy-MM');
		var current_y = dt.format('yyyy');
		var previous_y = dt.add('-1 year').format('yyyy');

		values.req_year_current = 0;
		values.req_year_previous = 0;
		values.req_month_current = 0;
		values.req_month_previous = 0;

		Object.keys(reqstats).forEach(function(key) {
			var year = key.substring(0, 4);
			var value = reqstats[key].request;
			if (year === current_y)
				values.req_year_current += value;
			if (year === previous_y)
				values.req_year_previous += value;
			if (key === current_m)
				values.req_month_current += value;
			if (key === previous_m)
				values.req_month_previous += value;
		});

		return values;
	}

	if (!CACHE('analyzator')) {
		CACHE('analyzator', '1', '4 days');
		SETTER('notifications', 'append', 'fa-bug', '@(More than 3 days you don\'t have launched <b>Logs analyzator</b>. Run it now.)', function() {
			SET('common.form', 'applications-analyzator');
		});
	}

</script>