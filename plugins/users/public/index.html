<ui-plugin>
	<header>
		<label><i class="ti ti-users-alt"></i>@(Users)</label>
		<nav class="toolbar pull-right">
			<button class="exec" data-exec="?/create"><i class="ti ti-plus-circle green"></i>@(Create)</button>
		</nav>
	</header>
	<ui-component naame="viewbox" config="parent:.ui-layout2-section;visibleX:true;visibleY:true;scrollbar:true;margin:45">

		<div class="padding">
			<ui-bind path="?.items" config="template" class="listing">
				<script type="text/html">
					{{ foreach m in value }}
					<figure data-id="{{ m.id }}">
						<div class="border{{ if m.id === user.id }} highlight{{ fi }}{{ if m.isdisabled }} disabled{{ fi }}">
							<div class="header npb">
								{{ if m.sa }}<div class="pull-right"><span class="badge badge-red">@(SuperAdmin)</span></div>{{ fi }}
								<div class="b{{ if m.isdisabled }} strike{{ fi }}">{{ m.name }}{{ if m.isonline }}<span class="badge badge-green badge-small ml5">@(online)</span>{{ fi }}</div>
							</div>
							<hr class="nmb" style="margin-top:12px" />
							<div class="padding">
								<div>
									<div class="keyvalue2 exec">
										<div class="value">{{ m.dtlogged | format('[ts]') | def }}</div>
										<div class="key">@(Logged)</div>
									</div>
									<div class="keyvalue2 exec">
										<div class="value">{{ m.dtcreated | format('[ts]') }}</div>
										<div class="key">@(Created)</div>
									</div>
								</div>
								<div class="buttons small mt10">
									<button class="exec" data-exec="?/update"><i class="ti ti-pencil"></i>@(Edit)</button>
									<button class="exec" data-exec="?/remove"{{ if m.id === user.id }} disabled{{ fi }}><i class="ti ti-trash red"></i>@(Remove)</button>
								</div>
							</div>
						</div>
					</figure>
					{{ end }}
				</script>
			</ui-bind>
		</div>

	</ui-component>
</ui-plugin>

<ui-component name="importer" path="common.form" config="if:usersform;url:/~ID~/forms/user.html"></ui-component>
<ui-component name="importer" path="common.form" config="if:profileform;url:/~ID~/forms/profile.html"></ui-component>

<script>
	PLUGIN(function(exports) {

		exports.reload = function() {
			EXEC('common/hidemenu');
			exports.refresh();
		};

		exports.refresh = function() {
			exports.tapi('users_query @showloading ERROR', 'items @hideloading');
		};

		exports.create = function() {
			SET('?form @default', {});
			SET('common.form', 'usersform');
		};

		exports.update = function(el) {
			var id = el.closest('figure').attrd('id');

			if (user.id === id) {
				SET('common.form', 'profileform');
				return;
			}

			exports.tapi('users_read/{0} @showloading ERROR'.format(id), function(response) {
				SET('usersform @reset @hideloading', response);
				SET('common.form', 'usersform');
			});
		};

		exports.remove = function(el) {
			var id = el.closest('figure').attrd('id');
			SETTER('approve/show', '@(Are you sure you want to remove selected user?)', '"ti ti-trash" Remove', function() {
				exports.tapi('users_remove/{0} @showloading ERROR'.format(id), function() {
					SETTER('notify/success @hideloading', '@(User has been removed sucessfully.)');
					exports.refresh();
				});
			});
		};

	});
</script>