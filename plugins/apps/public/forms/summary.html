<ui-component name="box" path="common.form" config="if:CLASS;title:@(Trending);width:1024;reload:?/reload;icon:ti ti-chart-line;closeesc:1;closeoutside:1" class="hidden" plugin="CLASS">
	<ui-bind path="?" config="template" class="padding npb block">
		<script type="text/html">
			{{ if value && value.is }}
			<div class="row">
				<div class="col-md-6 m">
					<h2><i class="ti ti-server"></i>@(Memory consumption)</h2>
					<table class="table table-bordered table-small">
						<tbody>
							{{ foreach m in value.memory }}
							<tr>
								{{ if m.empty }}
									<td class="col-xs-9">&nbsp;</td>
									<td class="col-xs-3 right active">&nbsp;</td>
								{{ else }}
									<td class="col-xs-9"><span class="badge {{ $index | summarycolor }} mr5">{{ $index | indexer }}</span><a href="{{ m.url }}" class="gray" target="_blank">{{ m.url }}</a></td>
									<td class="col-xs-3 right b black active">{{ m.value }}</td>
								{{ fi }}
							</tr>
							{{ end }}
						</tbody>
					</table>
				</div>

				{{ if value.cpu && value.cpu.length }}
					<div class="col-md-6 m">
						<h2><i class="ti ti-microchip-alt"></i>@(CPU consumption)</h2>
						<table class="table table-bordered table-small">
							<tbody>
								{{ foreach m in value.cpu }}
								<tr>
									{{ if m.empty }}
										<td class="col-xs-9">&nbsp;</td>
										<td class="col-xs-3 right active">&nbsp;</td>
									{{ else }}
										<td class="col-xs-9"><span class="badge {{ $index | summarycolor }} mr5">{{ $index | indexer }}</span><a href="{{ m.url }}" class="gray" target="_blank">{{ m.url }}</a></td>
										<td class="col-xs-3 right b black active">{{ m.value }} %</td>
									{{ fi }}
								</tr>
								{{ end }}
							</tbody>
						</table>
					</div>
				{{ fi }}

				<div class="col-md-6 m">
					<h2><i class="ti ti-hdd"></i>@(HDD consumption)</h2>
					<table class="table table-bordered table-small">
						<tbody>
							{{ foreach m in value.hdd }}
							<tr>
								{{ if m.empty }}
									<td class="col-xs-9">&nbsp;</td>
									<td class="col-xs-3 right active">&nbsp;</td>
								{{ else }}
									<td class="col-xs-9"><span class="badge {{ $index | summarycolor }} mr5">{{ $index | indexer }}</span><a href="{{ m.url }}" class="gray" target="_blank">{{ m.url }}</a></td>
									<td class="col-xs-3 right b black active">{{ m.value }}</td>
								{{ fi }}
							</tr>
							{{ end }}
						</tbody>
					</table>
				</div>

				<div class="col-md-6 m">
					<h2><i class="ti ti-folder"></i>@(Open files)</h2>
					<table class="table table-bordered table-small">
						<tbody>
							{{ foreach m in value.openfiles }}
							<tr>
								{{ if m.empty }}
									<td class="col-xs-9">&nbsp;</td>
									<td class="col-xs-3 right active">&nbsp;</td>
								{{ else }}
									<td class="col-xs-9"><span class="badge {{ $index | summarycolor }} mr5">{{ $index | indexer }}</span><a href="{{ m.url }}" class="gray" target="_blank">{{ m.url }}</a></td>
									<td class="col-xs-3 right b black active">{{ m.value | counter }}</td>
								{{ fi }}
							</tr>
							{{ end }}
						</tbody>
					</table>
				</div>

				<div class="col-md-6 m">
					<h2><i class="ti ti-globe"></i>@(Open connections)</h2>
					<table class="table table-bordered table-small">
						<tbody>
							{{ foreach m in value.connections }}
							<tr>
								{{ if m.empty }}
									<td class="col-xs-9">&nbsp;</td>
									<td class="col-xs-3 right active">&nbsp;</td>
								{{ else }}
									<td class="col-xs-9"><span class="badge {{ $index | summarycolor }} mr5">{{ $index | indexer }}</span><a href="{{ m.url }}" class="gray" target="_blank">{{ m.url }}</a></td>
									<td class="col-xs-3 right b black active">{{ m.value | counter }}</td>
								{{ fi }}
							</tr>
							{{ end }}
						</tbody>
					</table>
				</div>

				<div class="col-md-6 m">
					<h2><i class="ti ti-lock"></i>@(SSL expiration)</h2>
					<table class="table table-bordered table-small">
						<tbody>
							{{ foreach m in value.sslexpire }}
							<tr>
								{{ if m.empty }}
									<td class="col-xs-9">&nbsp;</td>
									<td class="col-xs-3 right active">&nbsp;</td>
								{{ else }}
									<td class="col-xs-9"><span class="badge {{ $index | summarycolor }} mr5">{{ $index | indexer }}</span><a href="{{ m.url }}" class="gray" target="_blank">{{ m.url }}</a></td>
									<td class="col-xs-3 right b black active">{{ m.value }}</td>
								{{ fi }}
							</tr>
							{{ end }}
						</tbody>
					</table>
				</div>
			</div>
		{{ fi }}
		</script>
	</ui-bind>
	<nav>
		<button name="cancel" style="width:100%">@(Close)</button>
	</nav>
</ui-component>

<script>

	PLUGIN(function(exports) {

		var caller;

		exports.reload = function() {

			caller = exports.caller;

			var output = {};
			var take = 5;
			output.is = true;
			output.cpu = exports.summary_find(take, 0, true);
			output.memory = exports.summary_find(take, 1, true);
			output.hdd = exports.summary_find(take, 2, true);
			output.openfiles = exports.summary_find(take, 3, true);
			output.connections = exports.summary_find(take, 4, true);
			output.sslexpire = exports.summary_find(take, 5, false);
			output.online = exports.summary_find(take, 6, true);
			output.visitors = exports.summary_find(take, 7, true);
			output.previous = exports.summary_find(take, 8, true);
			output.current = exports.summary_find(take, 9, true);

			exports.set(output);
		};

		exports.summary_find = function(max, type, desc) {

			var output = [];
			var apps = caller.model.apps;

			for (var app of apps) {

				var item = appsinfo['app' + app.id];
				if (!item)
					continue;

				var obj = {};
				obj.url = app.url;

				switch (type) {
					case 0: // cpu

						if (item.cpu == null)
							continue;

						obj.sorting = item.cpu;
						obj.value = item.cpu;

						if (!obj.sorting)
							continue;

						break;

					case 1: // memory

						if (item.memory == null)
							continue;

						obj.sorting = item.memory;
						obj.value = item.memory.filesize(1);
						break;

					case 2: // hdd

						if (item.hdd == null)
							continue;

						obj.sorting = item.hdd;
						obj.value = item.hdd.filesize(1);
						break;

					case 3: // openfiles

						if (item.openfiles == null)
							continue;

						obj.sorting = item.openfiles;
						obj.value = item.openfiles;
						break;

					case 4: // connections

						if (item.connections == null)
							continue;

						obj.sorting = item.connections;
						obj.value = item.connections;
						break;

					case 5: // ssl expire

						if (!item.sslexpire || app.url.substring(0, 6) !== 'https:')
							continue;

						var days = Math.ceil((item.sslexpire - Date.now()) / 86400000);

						obj.sorting = days;
						obj.value = days.pluralize(@('# days', '# day', '# days', '# days'));
						break;
				}

				output.push(obj);
			}

			output.sort(function(a, b) {
				if (desc)
					return a.sorting > b.sorting ? -1 : a.sorting === b.sorting ? 0 : 1;
				return a.sorting > b.sorting ? 1 : a.sorting === b.sorting ? 0 : -1;
			});

			return exports.summary_fill(output.take(max), max);
		};

		exports.summary_fill = function(arr, count) {
			for (var i = arr.length; i < count; i++)
				arr.push({ empty: true });
			return arr;
		};

	});

	Thelpers.summarycolor = function(value) {
		return 'badge-green' + value;
	};

</script>